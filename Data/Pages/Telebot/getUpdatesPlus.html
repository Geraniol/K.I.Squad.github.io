<html>

<head>
    <title>Telebot getUpdates Plus</title>
    <meta charset="UTF-8">
    <meta http-equiv="refresh" content="30">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="getUpdates+">
    <link rel="apple-touch-icon" href="./2.png">
</head>

<body>
    <style>
        .block {
            margin: 5px;
            border: 1px solid #121212;
            padding: 15px;
            border-radius: 10px;

            word-wrap: break-all;
            word-break: break-word;
        }
    </style>
    <div id="root">
        <input id="botToken" value="" htmlescape="false" placeholder="botToken">
        <input type="button" value="connect" onclick="getUpdates()">
    </div>
    <script>
        function login() {
            document.getElementById("root").innerHTML = '<input id="botToken" value="" htmlescape="false" placeholder="botToken">\n<input type="button" value="continue" onclick="getUpdates()">';
            load();
        }
        function randomColor() {
            return Math.floor(Math.random() * 0xffffff).toString(16);
        }


        function messageParser(message) {
            var result = "";
            const types = ["animation", "audio", "document", "photo", "sticker", "video", "video_note", "voice", "contact", "dice", "game", "poll", "pinned_message"];
            const trans = { "animation": "动画", "audio": "音频", "document": "文件", "photo": "图片", "sticker": "贴纸", "video": "视频", "voice": "语音", "contact": "名片", "game": "游戏", "poll": "投票", "pinned_message": "置顶一条消息" };
            const msgType = ["channel_post", "message"];
            for (var n = 0; n < msgType.length; n++) {
                if (msgType[n] in message) {
                    if ("text" in message[msgType[n]]) result += message[msgType[n]]["text"];
                    else if ("caption" in message[msgType[n]]) result += message[msgType[n]]["caption"];
                    else result += "--";
                    for (var i = 0; i < types.length; i++) {
                        if (types[i] in message[msgType[n]]) {
                            result += "<br>附加：" + trans[types[i]];
                        }
                    }
                }
            }
            return result;
        }


        function getUpdates() {
            var botToken = document.getElementById("botToken").value;
            localStorage.setItem("botToken", botToken);
            var xmlhttp = new XMLHttpRequest();
            xmlhttp.open("POST", "https://api.telegram.org/bot" + botToken + "/getUpdates", false);
            xmlhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xmlhttp.send("offset=-50");
            json = JSON.parse(xmlhttp.responseText);
            document.getElementById("root").innerHTML = "<div class='block' onclick='login()'>Return: " + JSON.stringify(json["ok"]) + ".&nbsp;Tap here to login.</div>";
            for (var i = json["result"].length - 1; i > -1; i--) {
                var item = messageParser(json["result"][i]);

                // var item = "";
                // try { item += JSON.stringify(json["result"][i]["channel_post"]["caption"]); } catch { }
                // try { item += JSON.stringify(json["result"][i]["channel_post"]["text"]); } catch { }
                // try { item += JSON.stringify(json["result"][i]["channel_post"]["sticker"]["emoji"]); } catch { }
                // try { item += JSON.stringify(json["result"][i]["message"]["caption"]); } catch { }
                // try { item += JSON.stringify(json["result"][i]["message"]["text"]); } catch { }
                // try { item += JSON.stringify(json["result"][i]["message"]["sticker"]["emoji"]); } catch { }
                document.getElementById("root").innerHTML += "<div class='block' style='background:#" + randomColor() + "88'>" + item + "</div>";
            }
        }
        function load() {
            botToken = localStorage.getItem("botToken");
            if (botToken) {
                document.getElementById("botToken").value = botToken;
            }
        }
        window.onload = () => { load(); getUpdates(); }
    </script>
</body>

</html>